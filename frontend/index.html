<!DOCTYPE html>

<script>
  var maps;

  document.addEventListener("input", function(evt) {
    if (/[\u4e00-\u9fa5]+/.test(evt.data)) {
      var [x, y] = get_td_coor(evt.path[1]);
      var term = get_term_by_coor(x, y)[0]["answer"];
      var direction = get_select_direction();
      for (var i = 0; i < evt.data.length; i++) {
        if (
          (direction == "h") & (y + i >= 10) ||
          (direction == "v") & (x + i >= 10)
        ) {
          return;
        }
        var cell =
          direction == "h"
            ? get_td_by_coor(x, y + i)
            : get_td_by_coor(x + i, y);
        if (cell.classList.contains("veil")) {
          return;
        }
        cell.getElementsByTagName("input")[0].value = evt.data[i];
      }
      check_answer();
    }
  });

  function check_answer() {
    for (var i = 0; i < 10; i++) {
      for (var j = 0; j < 10; j++) {
        var td = get_td_by_coor(i, j);
        if (td.classList.contains("veil") || td.classList.contains("correct")) {
          continue;
        }
        var correct_ans = get_correct_chr_by_coor(i, j);
        var input_cell = td.childNodes[0];
        if (input_cell.value == correct_ans) {
          input_cell.style.display = "none";
          td.innerHTML = correct_ans + input_cell.innerHTML;
          td.classList.add("correct");
        }
      }
    }
    return;
  }

  function get_td_coor(td) {
    return [td.parentNode.rowIndex, td.cellIndex];
  }

  function get_cursor_coor() {
    return get_td_coor(document.getElementsByClassName("cursor")[0]);
  }

  function get_term_by_coor(x, y) {
    var rs = [];
    for (var i = 0; i < maps.length; i++) {
      var start_coor = maps[i]["start_coor"];
      var direction = maps[i]["direction"];
      for (var j = 0; j < maps[i]["answer"].length; j++) {
        if (
          (direction == "h") &
          (start_coor[0] == x) &
          (start_coor[1] + j == y)
        ) {
          rs.push(maps[i]);
        } else if (
          (direction == "v") &
          (start_coor[0] + j == x) &
          (start_coor[1] == y)
        ) {
          rs.push(maps[i]);
        }
      }
    }
    return rs;
  }

  function get_correct_chr_by_coor(x, y) {
    for (var i = 0; i < maps.length; i++) {
      var start_coor = maps[i]["start_coor"];
      var direction = maps[i]["direction"];
      for (var j = 0; j < maps[i]["answer"].length; j++) {
        if (
          (direction == "h") &
          (start_coor[0] == x) &
          (start_coor[1] + j == y)
        ) {
          return maps[i]["answer"][j];
        } else if (
          (direction == "v") &
          (start_coor[0] + j == x) &
          (start_coor[1] == y)
        ) {
          return maps[i]["answer"][j];
        }
      }
    }
  }

  function get_td_by_coor(x, y) {
    return document.getElementsByTagName("tr")[x].getElementsByTagName("td")[y];
  }

  function get_select_direction() {
    var selected_cells = document.getElementsByClassName("selected");
    return selected_cells[0].cellIndex == selected_cells[1].cellIndex
      ? "v"
      : "h";
  }

  function get_coor_list_of_term(ans, maps) {
    var coor_list = [];
    for (var map of maps) {
      var start_coor = map["start_coor"];
      var direction = map["direction"];
      if (map["answer"] == ans) {
        for (var j = 0; j < map["answer"].split("").length; j++) {
          if (direction == "h") {
            coor_list.push([start_coor[0], start_coor[1] + j]);
          } else if (direction == "v") {
            coor_list.push([start_coor[0] + j, start_coor[1]]);
          }
        }
        return coor_list;
      }
    }
    return coor_list;
  }

  function cell_click(event) {
    var node = event.target;
    if (node.tagName == "INPUT") {
      node = node.parentElement;
    }
    if (node.classList.contains("veil")) {
      return;
    }
    while (document.getElementsByClassName("cursor").length > 0) {
      document.getElementsByClassName("cursor")[0].classList.remove("cursor");
    }
    node.classList.add("cursor");
    var [x, y] = get_td_coor(node);
    var terms = get_term_by_coor(x, y);
    if (
      !node.classList.contains("veil") &&
      !node.classList.contains("selected")
    ) {
      document.getElementsByClassName("hint")[0].innerText = terms[0]["hint"];
      var selected = document.getElementsByClassName("selected");
      selected = Array.from(selected);
      var s;
      for (s of selected) {
        s.classList.remove("selected");
      }
      var coor_list = get_coor_list_of_term(terms[0]["answer"], maps);
      for (var coor of coor_list) {
        get_td_by_coor(coor[0], coor[1]).classList.add("selected");
      }
    } else if (node.classList.contains("selected")) {
      if (terms.length == 2) {
        var current_text = document.getElementsByClassName("hint")[0].innerText;
        var term;
        for (term of terms) {
          if (term["hint"] != current_text) {
            document.getElementsByClassName("hint")[0].innerText = term["hint"];
            selected = document.getElementsByClassName("selected");
            selected = Array.from(selected);
            for (s of selected) {
              s.classList.remove("selected");
            }
            coor_list = get_coor_list_of_term(term["answer"], maps);
            for (coor of coor_list) {
              get_td_by_coor(coor[0], coor[1]).classList.add("selected");
            }
          }
        }
      }
    }
  }
  function showAnswer() {
    for (var map of maps) {
      var coor_list = get_coor_list_of_term(map["answer"], maps);
      for (var i = 0; i < coor_list.length; i++) {
        var td = get_td_by_coor(coor_list[i][0], coor_list[i][1]);
        td.innerHTML = map["answer"][i];
      }
    }
  }
  async function init() {
    document.getElementsByClassName("puzzleTable")[0].innerHTML = ""
    for (var i = 0; i < 10; i++) {
      var new_tr = document.createElement("tr");
      for (var j = 0; j < 10; j++) {
        var new_td = document.createElement("td");
        new_td.onclick = cell_click
        new_tr.append(new_td);
      }
      document.getElementsByClassName("puzzleTable")[0].append(new_tr);
    }

    await fetch("https://f97jw7.deta.dev/get-puzzle")
      .then((resp) => resp.json())
      .then((data) => (maps = data.map));
    var tds = document.getElementsByTagName("td");
    for (var td of tds) {
      td.classList.add("veil");
      td.innerHTML = "";
    }
    for (var i = 0; i < maps.length; i++) {
      var start_coor = maps[i]["start_coor"];
      var direction = maps[i]["direction"];
      for (var j = 0; j < maps[i]["answer"].split("").length; j++) {
        var cell = null;
        if ((direction == "h") & (start_coor[1] + j < 10)) {
          cell = get_td_by_coor(start_coor[0], start_coor[1] + j);
        } else if ((direction == "v") & (start_coor[0] + j < 10)) {
          cell = get_td_by_coor(start_coor[0] + j, start_coor[1]);
        }
        cell.classList = [];
        if (cell.childNodes.length == 0) {
          var input_cell = document.createElement("input");
          input_cell.classList.add("input_cell");
          input_cell.type = "text";
          cell.append(input_cell);
        }
      }
    }
  }
</script>

<html>
  <head>
    <link rel="icon" type="image/png" href="assets/favicon.ico"/>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body onload="init()">
    <div class="main">
      <div id="option">
        <button onclick="init()">Init</button>
        <button onclick="showAnswer()">Show Answer</button>
      </div>
      <div>
        <table class="puzzleTable">
        </table>
      </div>
      <div class="hint">提示文本</div>
    </div>
  </body>
</html>
